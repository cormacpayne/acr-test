name: Test Oryx Dockerfile

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        app:
          - azureFunctionsApps/DotNetCore_HttpTriggerV3Sample
          - azureFunctionsApps/Node_HttpTriggerSample
          - azureFunctionsApps/Python_HttpTriggerSample
          - DotNetCore/Net5BlazorWasmClientApp
          - DotNetCore/Net5MvcApp
          - DotNetCore/NetCore6BlazorWasmApp
          - DotNetCore/NetCore6PreviewMvcApp
          - DotNetCore/NetCore7PreviewMvcApp
          - DotNetCore/NetCoreApp30.MvcApp
          - DotNetCore/NetCoreApp31.MvcApp
          - nodejs/angular6app
          - nodejs/angular8app
          - nodejs/express-config-js
          - nodejs/helloworld-nuxtjs
          - nodejs/monorepo-lerna-npm
          - nodejs/nextjs-yarn2-example
          - nodejs/node-mssql
          - nodejs/node-postgres
          - nodejs/vuepress
          - nodejs/webfrontend-yarnlock
          - python/django-app
          - python/flask-app
          - python/http-server-py
          - python/mssqlserver-sample
          - python/postgres-sample
          - python/shapely-flask-app

    steps:
      - uses: actions/checkout@v3
        with:
          repository: microsoft/Oryx
      
      - name: Generate Dockerfile
        run: docker run --rm -v $(pwd)/tests/SampleApps/${{ matrix.app }}:/app mcr.microsoft.com/oryx/build:github-actions oryx dockerfile --output /app/test.Dockerfile /app
      
      - name: Edit Dockerfile
        run: |
          sed -i 's/\&\& oryx/\&\& oryx create-script/' $(pwd)/tests/SampleApps/${{ matrix.app }}/test.Dockerfile
          sed -i 's/build\:latest/build\:azfunc-jamstack/' $(pwd)/tests/SampleApps/${{ matrix.app }}/test.Dockerfile
          sed -i -E '1s/(.*):.*/\1:dynamic/' $(pwd)/tests/SampleApps/${{ matrix.app }}/test.Dockerfile
        
      - name: Display Dockerfile
        run: cat $(pwd)/tests/SampleApps/${{ matrix.app }}/test.Dockerfile
        
      - name: Build Dockerfile
        run: docker build -t test:tag -f $(pwd)/tests/SampleApps/${{ matrix.app }}/test.Dockerfile $(pwd)/tests/SampleApps/${{ matrix.app }}
